import numpy as np
from typing import Dict,Text
import torch as t
import torch.functional as f
from torch import nn
from torch.autograd import Variable
from config import Config
opt = Config()
def generate(model, start_words, ix2word, word2ix, prefix_words=None):
    """
    给定几个词，根据这几个词接着生成一首完整的诗歌
    start_words：u'春江潮水连海平'
    比如start_words 为 春江潮水连海平，可以生成：

    """

    results = list(start_words)
    start_word_len = len(start_words)
    # 手动设置第一个词为<START>
    input = t.tensor([word2ix['<START>']]).view(1, 1).long()
    #input = t.tensor([word2ix[results[0]]]).view(1, 1).long()

    if opt.use_gpu: input = input.cuda()
    hidden = None

    if prefix_words:
        for word in prefix_words:
            output, hidden = model(input, hidden)
            input = input.data.new([word2ix[word]]).view(1, 1)

    for i in range(opt.max_gen_len):
        output, hidden = model(input, hidden)

        if i <start_word_len:
            w = results[i]
            input = input.data.new([word2ix[w]]).view(1, 1)
            output, hidden = model(input, hidden)
        else:
            top_index = output.data[0].topk(1)[1][0].item()
            print('topindex',top_index)
            w = ix2word[top_index]
            results.append(w)
            input = input.data.new([top_index]).view(1, 1)
        if w == '<EOP>':
            #del results[-1]
            break
    return results
